name: reusable policy conformance
on:
  workflow_call: {}
jobs:
  conform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - id: ref
        run: |
          REF='${{ github.ref }}'
          if [ -n '${{ github.head_ref }}' ]; then
            REF='refs/heads/${{ github.head_ref }}'
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
      - name: conform
        env:
          INPUT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF: ${{ steps.ref.outputs.ref }}
        run: |
          docker run \
            -e INPUT_TOKEN \
            -e GITHUB_EVENT_PATH \
            -v "$PWD:$PWD" \
            -v "/home/runner/work/_temp/_github_home":"/github/home" \
            -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" \
            -v "/home/runner/work/_temp/_runner_file_commands":"/github/file_commands" \
            ghcr.io/geonet/base-images/siderolabs-conform:v0.1.0-alpha.27 \
            enforce --commit-ref="$REF" --reporter=github
