name: reusable policy conformance
on:
  workflow_call: {}
jobs:
  conform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - id: ref
        run: |
          REF='${{ github.ref }}'
          if [ -n '${{ github.head_ref }}' ]; then
            REF='refs/heads/${{ github.head_ref }}'
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
      - name: conform
        env:
          INPUT_TOKEN: ${{ github.token }}
          REF: ${{ steps.ref.outputs.ref }}
        run: |
          docker run \
            --workdir /github/workspace \
            --rm \
            -e "INPUT_TOKEN" \
            -e "INPUT_ARGS" \
            -e "HOME" \
            -e "GITHUB_JOB" \
            -e "GITHUB_REF" \
            -e "GITHUB_SHA" \
            -e "GITHUB_REPOSITORY" \
            -e "GITHUB_REPOSITORY_OWNER" \
            -e "GITHUB_REPOSITORY_OWNER_ID" \
            -e "GITHUB_RUN_ID" \
            -e "GITHUB_RUN_NUMBER" \
            -e "GITHUB_RETENTION_DAYS" \
            -e "GITHUB_RUN_ATTEMPT" \
            -e "GITHUB_REPOSITORY_ID" \
            -e "GITHUB_ACTOR_ID" \
            -e "GITHUB_ACTOR" \
            -e "GITHUB_TRIGGERING_ACTOR" \
            -e "GITHUB_WORKFLOW" \
            -e "GITHUB_HEAD_REF" \
            -e "GITHUB_BASE_REF" \
            -e "GITHUB_EVENT_NAME" \
            -e "GITHUB_SERVER_URL" \
            -e "GITHUB_API_URL" \
            -e "GITHUB_GRAPHQL_URL" \
            -e "GITHUB_REF_NAME" \
            -e "GITHUB_REF_PROTECTED" \
            -e "GITHUB_REF_TYPE" \
            -e "GITHUB_WORKFLOW_REF" \
            -e "GITHUB_WORKFLOW_SHA" \
            -e "GITHUB_WORKSPACE" \
            -e "GITHUB_ACTION" \
            -e "GITHUB_EVENT_PATH" \
            -e "GITHUB_ACTION_REPOSITORY" \
            -e "GITHUB_ACTION_REF" \
            -e "GITHUB_PATH" \
            -e "GITHUB_ENV" \
            -e "GITHUB_STEP_SUMMARY" \
            -e "GITHUB_STATE" \
            -e "GITHUB_OUTPUT" \
            -e "RUNNER_OS" \
            -e "RUNNER_ARCH" \
            -e "RUNNER_NAME" \
            -e "RUNNER_ENVIRONMENT" \
            -e "RUNNER_TOOL_CACHE" \
            -e "RUNNER_TEMP" \
            -e "RUNNER_WORKSPACE" \
            -e "ACTIONS_RUNTIME_URL" \
            -e "ACTIONS_RUNTIME_TOKEN" \
            -e "ACTIONS_CACHE_URL" \
            -e GITHUB_ACTIONS=true \
            -e CI=true \
            -v "/var/run/docker.sock":"/var/run/docker.sock" \
            -v "/home/runner/work/_temp/_github_home":"/github/home" \
            -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" \
            -v "/home/runner/work/_temp/_runner_file_commands":"/github/file_commands" \
            -v "$PWD":"/github/workspace" \
            ghcr.io/siderolabs/conform:v0.1.0-alpha.27 enforce --commit-ref="$REF" --reporter=github
